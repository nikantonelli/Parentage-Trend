<!DOCTYPE html>
<html>
<head>
    <title>Parentage-Trend</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",stateful:!0,stateId:"NiksApps_LBAPI_Parentage"+Ext.id(),config:{defaultSettings:{atDate:Ext.Date.format(new Date,"Y-m-d"),dateDuration:0}},items:[{xtype:"container",itemId:"option_box",layout:"hbox"}],_haveParent:function(e){var t="HierarchicalRequirement"===e.type.typePath?this.types[1].name:"Parent";return e.record.get(t)>0?_.find(this.nodes,function(r){return r.record.get("ObjectID")===e.record.get(t)}):null},_findDepth:function(e){var t=-1,r=e;do{r=this._haveParent(r),t+=1}while(r);return t},_processResults:function(e){var t=this;t._Items=[],_.each(t.types,function(){for(var e=[],r=0;r<t.types.length;r++)e.push(0);t._Items.push(e)}),t.nodes=[],_.each(e,function(e){_.each(e.results,function(r){t.nodes.push({type:e.type,record:r})})}),_.each(t.nodes,function(e){for(var r=_.findIndex(t.types,function(t){return t.typePath===e.type.typePath}),a=t._findDepth(e);a>=0;a--)t._Items[r][r+a]+=1});for(var r=0;r<t.types.length-1;r++)for(var a=r+1;a<t.types.length;a++)t._Items[r][r]>0&&(t._Items[r][a]=t._Items[r][a]/t._Items[r][r]*100);var o=[{name:"type",type:"string"},{name:"total",type:"int"}];_.each(Ext.clone(this.types).reverse(),function(e){o.push({name:e.name,type:"float"})}),Ext.define("Niks.Tree.Record",{extend:"Ext.data.Model",fields:o,isUpdatable:function(){return!1},isTimebox:function(){return!1},isUser:function(){return!1},isMilestone:function(){return!1}});var n=[];return _.each(t._Items,function(e,r){var a=_.find(n,{type:t.types[r].name});a||(n.push({type:t.types[r].name,total:t._Items[r][r]}),a=_.find(n,{type:t.types[r].name}));for(var o=r+1;o<t.types.length;o++)a[t.types[o].name]=t._Items[r][o]}),Ext.create("Ext.data.Store",{model:"Niks.Tree.Record",data:n})},_drawGrid:function(e){this.down("#grid")&&this.down("#grid").destroy();for(var t=[{text:"Type",dataIndex:"type"}],r=1;r<this.types.length;r++)t.push({text:"Percent to: "+this.types[r].name,dataIndex:this.types[r].name,flex:1,renderer:function(e){return e.toFixed(1)}});t.push({text:"Total",dataIndex:"total"}),this.add({xtype:"grid",model:"Niks.Tree.Record",store:e,columns:t,height:120,width:800}),this.add({xtype:"component",width:800,align:"center",html:"<p>Sample Date:   "+Ext.Date.format(this.date,"j M Y")+"</p>"});var a=this.getSetting("dateDuration");a>0&&this.add({xtype:"component",width:800,align:"center",html:"<p>Artefacts created between "+Ext.Date.format(Ext.Date.subtract(this.date,Ext.Date.MONTH,a),"j M Y")+" and "+Ext.Date.format(this.date,"j M Y")+"</p>"})},types:[],categories:[],series:[],_loadRecordTypeSnapshots:function(e,t,r){var a=[],o="PortfolioItem";return"HierarchicalRequirement"===e.typePath?o=e.typePath:a.push({property:"PortfolioItemType",operator:"=",value:Number(e.type)}),a.push({property:"_TypeHierarchy",value:o}),t&&t.length>0&&(a=a.concat(t)),this._loadRecordSnapshots(a,r)},_loadRecordSnapshots:function(e,t){var r=Ext.create("Deft.Deferred"),a=[{property:"__At",value:Ext.Date.format(t,"Y-m-d\\TH:i:s")},{property:"_ProjectHierarchy",value:this.getContext().getProject().ObjectID}].concat(e),o=this.getSetting("dateDuration");return o>0&&(a.push({property:"CreationDate",operator:">",value:Ext.Date.format(Ext.Date.subtract(t,Ext.Date.MONTH,o),"Y-m-d\\TH:i:s")}),a.push({property:"CreationDate",operator:"<",value:Ext.Date.format(t,"Y-m-d\\TH:i:s")})),Ext.create("Rally.data.lookback.SnapshotStore",{filters:a,limit:1/0,pageSize:2e3,useHttpPost:!0,fetch:["_ValidFrom","_ValidTo","ObjectID","Children","Parent","UserStories",this.types[1].name]}).load({callback:function(e,t,a){console.log("callback: ",e,t,a),a?(console.log("Store fetched returned :",e.length),r.resolve(e)):(console.log("Failed to fetch Snapshots: ",t),r.resolve([]))}}),r.promise},_getOneLevelItems:function(e,t){var r=Ext.create("Deft.Deferred");return this._loadRecordTypeSnapshots(e,t,this.date).then({success:function(e){r.resolve(e)}}),r.promise},_Items:[],_getNumbersForType:function(e){var t=Ext.create("Deft.Deferred");return this._getOneLevelItems(e,[]).then({success:function(r){t.resolve({type:e,results:r})},failure:function(r){console.log("Failed to getOneLevelItems for: ",e),t.reject(r)}}),t.promise},launch:function(){var e=this;e.getSetting("atDate")&&e.getSetting("atDate").length>0?e.date=new Date(e.getSetting("atDate")):e.date=new Date,e.setLoading("Fetching portfolio item types"),this._fetchPortfolioItemTypes().then({success:function(t){e.setLoading("Fetching data for: "+Ext.Date.format(e.date,"Y/m/d")),t.splice(0,0,{typePath:"HierarchicalRequirement",name:"User Story",parentType:t[0]}),e.types=t;var r=[];_.each(t,function(t){r.push(function(){return e.setLoading("Fetching all of type: "+t.name),e._getNumbersForType(t)})}),Deft.Chain.sequence(r).then({success:function(t){var r=e._processResults(t);e._drawGrid(r)},failure:function(e){console.log("Failed to fetch sequence: ",e)},scope:e}).always(function(){e.setLoading(!1)})},failure:function(){console.log("Failed to fetch portfolioitem types")},scope:e}).always(function(){e.setLoading(!1)})},getSettingsFields:function(){return[{name:"atDate",fieldLabel:"Use data as of:",labelWidth:150,xtype:"rallydatefield",allowBlank:!0,blankText:"Use todays date"},{name:"dateDuration",labelWidth:150,fieldLabel:"Creation Period (months prior)",xtype:"rallynumberfield",margin:"0 0 150 0",value:0}]},_fetchPortfolioItemTypes:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]}).load({callback:function(t,r,a){if(a){var o=new Array(t.length);_.each(t,function(e){var t=Number(e.get("Ordinal"));o[t]={typePath:e.get("TypePath"),name:e.get("Name"),type:e.get("_ref").split("/").pop()}});for(var n=0;n<o.length-1;n++)o[n].parentType=o[n+1];e.resolve(o)}else{var i="";r&&r.error&&r.error.errors&&(i=r.error.errors.join(",")),e.reject("Error loading Portfolio Item Types:  "+i)}}}),e.promise}});

            Rally.launchApp('CustomApp', {
                name:"Parentage-Trend",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        p{display:block;margin-top:1em;margin-bottom:1em;margin-left:0;margin-right:0;font-size:16px;width:750;text-align:center}
    </style>
</head>
<body>
</body>
</html>
