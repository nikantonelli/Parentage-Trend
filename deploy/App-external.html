<!DOCTYPE html>
<html>
<head>
    <title>Parentage-Trend</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{periodName:"Day",periodCount:64,endDate:new Date}},items:[{xtype:"container",itemId:"option_box",layout:"hbox"}],_getParents:function(e){var t=Ext.create("Deft.Deferred"),r=[];return _.each(this.types,function(t){r.push(function(){var r=Ext.create("Deft.Deferred"),a=null;return a="HierarchicalRequirement"===t.typePath?{property:t.parentType.name,operator:">",value:0}:{property:"Parent",operator:">",value:0},this._loadRecordCount(t.typePath,a,t.name,e).then({success:function(e){r.resolve(e)},failure:function(e){console.log("Failed: ",e),r.reject(e)}}),r.promise})},this),Deft.Chain.parallel(r,this).then({success:function(e){var r={};_.each(e,function(e){r=Ext.merge(r,e)}),t.resolve(r)},failure:function(e){console.log("GetTotals Failed: ",e),t.reject(e)}}),t},_getTotals:function(e){var t=Ext.create("Deft.Deferred"),r=[];return _.each(this.types,function(t){r.push(function(){var r=Ext.create("Deft.Deferred");return this._loadRecordCount(t.typePath,{property:"ObjectID",operator:">",value:0},t.name,e).then({success:function(e){r.resolve(e)},failure:function(e){console.log("Failed: ",e),r.reject(e)}}),r.promise})},this),Deft.Chain.parallel(r,this).then({success:function(e){var r={};_.each(e,function(e){r=Ext.merge(r,e)}),t.resolve(r)},failure:function(e){console.log("GetTotals Failed: ",e),t.reject(e)}}),t},_processResults:function(e){var t=this,r=Object.keys(e[0].point[0]);_.each(e,function(e){_.each(r,function(r){_.find(t.series,function(e){return e.name===r}).data.push(e.point[1][r]/(e.point[0][r]>0?e.point[0][r]:1)*100)})})},_updateChart:function(e){this._processResults(e),this.down("#trendChart")&&this.down("trendChart").destroy(),this.add({xtype:"rallychart",itemId:"trendChart",height:this.getHeight()-this.down("#option_box").getHeight(),chartData:{categories:this.categories,series:this.series},chartConfig:{chart:{type:"line"},title:{text:"Percent Correct Parentage"},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e-%b-%y",month:"%b-%y"}},yAxis:{min:0,max:100,title:{text:"Percentage"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}}})},types:[],categories:[],series:[],_getData:function(e){var t=Ext.create("Deft.Deferred"),r=[];return r.push(this._getTotals(e)),r.push(this._getParents(e)),console.log(r),Deft.Promise.all(r).then({success:function(r){t.resolve({date:e,point:r})},failure:function(e){console.log("Totals Failed: ",e),t.reject(e)},scope:this}),t.promise},launch:function(){var e=this;this._fetchPortfolioItemTypes().then({success:function(t){t.splice(0,0,{typePath:"HierarchicalRequirement",name:"User Story",parentType:t[0]}),e.types=t;var r=e.down("#option_box");_.each(t,function(t){r.add({xtype:"rallycheckboxfield",fieldLabel:t.name,itemId:t.typePath.split("/").pop(),margin:"10 0 5 15",labelAlign:"right",listeners:{change:function(){e._updateChart()}}})}),_.each(t,function(t){e.series.push({name:t.name,data:[]})});var a=this.getSetting("periodCount")||this.config.defaultSettings.periodCount,o=0;switch(this.getSetting("periodName")){case"Day":o=1;break;case"Week":o=7;break;case"Fortnight":o=14}for(var n=o?Ext.Date.DAY:Ext.Date.MONTH,i=new Date(this.getSetting("endDate")||Ext.Date.now()),s=o?"j/n/y":"M, y",l=[],c=[],p=0;p<a;p++)c.push(Ext.Date.subtract(i,n,o?o*p:1));c.every(function(t){return e.categories.push(Ext.Date.format(t,s)),l.push(function(){return e.setLoading("Fetching data for: "+Ext.Date.format(t,s)),e._getData(t)}),!0}),Deft.Chain.sequence(l).then({success:function(t){e._updateChart(t)},failure:function(e){console.log("Failed to execute series loop: ",e)}}).always(function(){e.setLoading(!1)})},failure:function(){console.log("Failed to fetch portfolioitem types")},scope:e})},getSettingsFields:function(){return[{name:"periodName",fieldLabel:"Period Type",xtype:"rallycombobox",allowBlank:!1,autoSelect:!0,initialValue:"Week",displayField:"name",valueField:"name",storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name"],data:[{name:"Day"},{name:"Week"},{name:"Fortnight"},{name:"Month"},{name:"Quarter"}]}},{name:"periodCount",xtype:"rallynumberfield",minValue:3,maxValue:32,fieldLabel:"Period Count",value:1},{name:"endDate",fieldLabel:"End Date",xtype:"rallydatefield"}]},_loadRecordCount:function(e,t,r,a){var o=Ext.create("Deft.Deferred");console.log("Starting load: ",a," >> ",e,"filters >> ",JSON.stringify(t));var n=[{property:"_TypeHierarchy",operator:"in",value:[e]},{property:"__At",value:Ext.Date.format(a,"Y-m-d\\TH:i:s")},{property:"_ProjectHierarchy",value:this.getContext().getProject().ObjectID}];return n=n.concat(t),Ext.create("Rally.data.lookback.SnapshotStore",{filters:n,limit:1,pageSize:1}).load({callback:function(e,t,a){var n={};a?(console.log("result:",t),n[r]=t.resultSet.totalRecords||0,o.resolve(n)):(console.log("Failed: ",t),n[r]=0,o.resolve(n))}}),o.promise},_fetchPortfolioItemTypes:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]}).load({callback:function(t,r,a){if(a){var o=new Array(t.length);_.each(t,function(e){var t=Number(e.get("Ordinal"));o[t]={typePath:e.get("TypePath"),name:e.get("Name")}});for(var n=0;n<o.length-1;n++)o[n].parentType=o[n+1];e.resolve(o)}else{var i="";r&&r.error&&r.error.errors&&(i=r.error.errors.join(",")),e.reject("Error loading Portfolio Item Types:  "+i)}}}),e.promise}});

            Rally.launchApp('CustomApp', {
                name:"Parentage-Trend",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
