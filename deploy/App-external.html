<!DOCTYPE html>
<html>
<head>
    <title>Parentage-Trend</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{periodName:"Day",periodCount:32,endDate:new Date}},items:[{xtype:"container",itemId:"option_box",layout:"hbox"}],_getParents:function(){var e=this,t=Ext.create("Deft.Deferred"),a=[];return _.each(this.types,function(t){a.push(function(){var a=Ext.create("Deft.Deferred"),r=null;return r="hierarchicalrequirement"===t.typePath?Rally.data.wsapi.Filter.fromQueryString("("+t.parentType.name+".ObjectID >0)"):Rally.data.wsapi.Filter.fromQueryString("(Parent.ObjectID >0)"),this._loadRecordCount(t.typePath,r,t.name).then({success:function(t){e.parented.push(t),a.resolve(t)},failure:function(e){console.log("Failed: ",e),a.reject(e)}}),a.promise})},this),Deft.Chain.parallel(a,this).then({success:function(e){t.resolve(e)},failure:function(e){console.log("GetTotals Failed: ",e),t.reject(e)}}),t},_getTotals:function(){var e=this,t=Ext.create("Deft.Deferred"),a=[];return _.each(this.types,function(t){a.push(function(){var a=Ext.create("Deft.Deferred");return this._loadRecordCount(t.typePath,Rally.data.wsapi.Filter.fromQueryString("(ObjectID >0)"),t.name).then({success:function(t){e.totals.push(t),a.resolve(t)},failure:function(e){console.log("Failed: ",e),a.reject(e)}}),a.promise})},this),Deft.Chain.parallel(a,this).then({success:function(e){t.resolve(e)},failure:function(e){console.log("GetTotals Failed: ",e),t.reject(e)}}),t},_updateChart:function(){},types:[],totals:[],parented:[],unparented:[],_getData:function(e){var t=this;t.types=e,Deft.Chain.sequence([this._getTotals,this._getParents],t).then({success:function(e){console.log("Totals Succeeded: ",e)},failure:function(e){console.log("Totals Failed: ",e)},scope:t}).always(function(){t._updateChart()})},launch:function(){var e=this;this._fetchPortfolioItemTypes().then({success:function(t){t.splice(0,0,{typePath:"hierarchicalrequirement",name:"User Story",parentType:t[0]});var a=e.down("#option_box");_.each(t,function(t){a.add({xtype:"rallycheckboxfield",fieldLabel:t.name,itemId:t.typePath.split("/").pop(),margin:"10 0 5 15",labelAlign:"right",listeners:{change:function(){e._updateChart()}}})}),e._getData(t)},failure:function(){console.log("Failed to fetch portfolioitem types")},scope:e})},getSettingsFields:function(){return[{name:"periodName",fieldLabel:"Period Type",xtype:"rallycombobox",allowBlank:!1,autoSelect:!0,initialValue:"Week",displayField:"name",valueField:"name",storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name"],data:[{name:"Day"},{name:"Week"},{name:"Fortnight"},{name:"Month"},{name:"Quarter"}]}},{name:"periodCount",xtype:"rallynumberfield",minValue:3,maxValue:32,fieldLabel:"Period Count",value:14},{name:"endDate",fieldLabel:"End Date",xtype:"rallydatefield"}]},_loadRecordCount:function(e,t,a){var r=Ext.create("Deft.Deferred");return console.log("Starting load: model>>",e,"filters>>",t.toString()),Ext.create("Rally.data.wsapi.Store",{model:e,filters:t,limit:1,pageSize:1}).load({callback:function(e,t,o){var n={};o?(console.log("result:",t),n[a]=t.resultSet.totalRecords||0,r.resolve(n)):(console.log("Failed: ",t),n[a]=0,r.resolve(n))}}),r.promise},_fetchPortfolioItemTypes:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]}).load({callback:function(t,a,r){if(r){var o=new Array(t.length);_.each(t,function(e){var t=Number(e.get("Ordinal"));o[t]={typePath:e.get("TypePath").toLowerCase(),name:e.get("Name")}});for(var n=0;n<o.length-1;n++)o[n].parentType=o[n+1];e.resolve(o)}else{var l="";a&&a.error&&a.error.errors&&(l=a.error.errors.join(",")),e.reject("Error loading Portfolio Item Types:  "+l)}}}),e.promise}});

            Rally.launchApp('CustomApp', {
                name:"Parentage-Trend",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
