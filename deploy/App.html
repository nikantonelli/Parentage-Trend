<!DOCTYPE html>
<html>
<head>
    <title>Parentage-Trend</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{startDate:Ext.Date.format(Ext.Date.subtract(new Date,Ext.Date.MONTH,12),"Y-m-d"),endDate:Ext.Date.format(new Date,"Y-m-d")}},items:[{xtype:"container",itemId:"option_box",layout:"hbox"}],_processResults:function(e){var t=this,a=[{name:"type",type:"string"},{name:"total",type:"int"}];_.each(Ext.clone(this.types).reverse(),function(e){a.push({name:e.name,type:"int"})}),Ext.define("Niks.Tree.Record",{extend:"Ext.data.Model",fields:a,isUpdatable:function(){return!1},isTimebox:function(){return!1},isUser:function(){return!1},isMilestone:function(){return!1}});var r=[];return _.each(e,function(e){var a=_.find(r,{type:t.types[e.y].name});if(a)a[t.types[e.x].name]=e.count;else if(e.x===e.y)r.push({type:t.types[e.y].name,total:e.count});else{var n={type:t.types[e.y].name};n[t.types[e.x].name]=e.count,r.push(n)}}),Ext.create("Ext.data.Store",{model:"Niks.Tree.Record",data:r})},_drawGrid:function(e){var t=this._processResults(e);this.down("#grid")&&this.down("grid").destroy();for(var a=[{text:"Type",dataIndex:"type"}],r=1;r<this.types.length;r++)a.push({text:"Percent to: "+this.types[r].name,dataIndex:this.types[r].name,flex:1,renderer:function(e,t,a){return(a.get("total")?e/a.get("total")*100:0).toFixed(1)}});a.push({text:"Total",dataIndex:"total"}),this.add({xtype:"grid",model:"Niks.Tree.Record",store:t,columns:a,height:300,width:800})},types:[],categories:[],series:[],_getData:function(e){var t=Ext.create("Deft.Deferred");return this._loadRecordCount(e.type.typePath,e.parentField?"("+e.parentField+" >0)":null,e.x,e.y).then({success:function(a){t.resolve({x:e.x,y:e.y,count:a})},failure:function(e){console.log("Totals Failed: ",e),t.reject(e)},scope:this}),t.promise},launch:function(){var e=this;this._fetchPortfolioItemTypes().then({success:function(t){t.splice(0,0,{typePath:"HierarchicalRequirement",name:"User Story",parentType:t[0]}),e.types=t,_.each(t,function(t){e.series.push({name:t.name,data:[]})});var a=[];_.each(t,function(r,n){var o="Parent";"HierarchicalRequirement"===r.typePath&&(o=t[1].name),console.log({type:r,x:t.length-(n+1),y:t.length-(n+1),parentField:null}),a.push(function(){return e._getData(Ext.clone({type:r,x:n,y:n,parentField:null}))});for(var i=[],l=n+1;l<t.length;l++){var s={type:r,x:l,y:n,parentField:o+".ObjectID"};i.push(s),console.log(s),o+=".Parent"}_.each(i,function(t){a.push(function(){return e._getData(Ext.clone(t))})})}),Deft.Chain.parallel(a).then({success:function(t){e._drawGrid(t)},failure:function(e){console.log("Failed to execute loop: ",e)}}).always(function(){e.setLoading(!1)})},failure:function(){console.log("Failed to fetch portfolioitem types")},scope:e})},getSettingsFields:function(){return[{name:"startDate",fieldLabel:"Start Date",xtype:"rallydatefield"},{name:"endDate",fieldLabel:"End Date",xtype:"rallydatefield"}]},_loadRecordCount:function(e,t){var a=Ext.create("Deft.Deferred"),r=this.getSetting("startDate"),n=this.getSetting("endDate");console.log("Starting load: ",r,n," >> ",e,"filters >> ",t);var o="((CreationDate >"+r+") AND (CreationDate <"+n+"))",i=Rally.data.wsapi.Filter.fromQueryString(o);return t&&(i=Rally.data.wsapi.Filter.and([Rally.data.wsapi.Filter.fromQueryString(t||"()"),i])),Ext.create("Rally.data.wsapi.Store",{model:e.toLowerCase(),filters:i,limit:1,pageSize:1}).load({callback:function(e,t,r){r?(console.log("result:",t),a.resolve(t.resultSet.totalRecords||0)):(console.log("Failed: ",t),a.resolve(0))}}),a.promise},_fetchPortfolioItemTypes:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]}).load({callback:function(t,a,r){if(r){var n=new Array(t.length);_.each(t,function(e){var t=Number(e.get("Ordinal"));n[t]={typePath:e.get("TypePath"),name:e.get("Name")}});for(var o=0;o<n.length-1;o++)n[o].parentType=n[o+1];e.resolve(n)}else{var i="";a&&a.error&&a.error.errors&&(i=a.error.errors.join(",")),e.reject("Error loading Portfolio Item Types:  "+i)}}}),e.promise}});

            Rally.launchApp('CustomApp', {
                name:"Parentage-Trend",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
