<!DOCTYPE html>
<html>
<head>
    <title>Parentage-Trend</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",stateful:!0,stateId:"NiksApps_LBAPI_Parentage"+Ext.id(),config:{defaultSettings:{atDate:Ext.Date.format(new Date,"Y-m-d")}},items:[{xtype:"container",itemId:"option_box",layout:"hbox"}],_haveParent:function(e){var t="HierarchicalRequirement"===e.type.typePath?this.types[1].name:"Parent";return e.record.get(t)>0?_.find(this.nodes,function(r){return r.record.get("ObjectID")===e.record.get(t)}):null},_hasChildren:function(e){var t="Children";return e.type.typePath===this.types[1].typePath&&(t="UserStories"),e.record.get(t).length},_findDepth:function(e){var t=-1,r=e;do{r=this._haveParent(r),t+=1}while(r);return t},_processResults:function(e){var t=this;t._Items=[],_.each(t.types,function(){for(var e=[],r=0;r<t.types.length;r++)e.push(0);t._Items.push(e)}),t.nodes=[],_.each(e,function(e){_.each(e.results,function(r){t.nodes.push({type:e.type,record:r})})}),_.each(t.nodes,function(e){for(var r=_.findIndex(t.types,function(t){return t.typePath===e.type.typePath}),o=t._findDepth(e);o>=0;o--)t._Items[r][r+o]+=1});for(var r=0;r<t.types.length-1;r++)for(var o=r+1;o<t.types.length;o++)t._Items[r][r]>0&&(t._Items[r][o]=t._Items[r][o]/t._Items[r][r]*100);var n=[{name:"type",type:"string"},{name:"total",type:"int"}];_.each(Ext.clone(this.types).reverse(),function(e){n.push({name:e.name,type:"float"})}),Ext.define("Niks.Tree.Record",{extend:"Ext.data.Model",fields:n,isUpdatable:function(){return!1},isTimebox:function(){return!1},isUser:function(){return!1},isMilestone:function(){return!1}});var a=[];return _.each(t._Items,function(e,r){var o=_.find(a,{type:t.types[r].name});o||(a.push({type:t.types[r].name,total:t._Items[r][r]}),o=_.find(a,{type:t.types[r].name}));for(var n=r+1;n<t.types.length;n++)o[t.types[n].name]=t._Items[r][n]}),Ext.create("Ext.data.Store",{model:"Niks.Tree.Record",data:a})},_drawGrid:function(e){this.down("#grid")&&this.down("#grid").destroy();for(var t=[{text:"Type",dataIndex:"type"}],r=1;r<this.types.length;r++)t.push({text:"Percent to: "+this.types[r].name,dataIndex:this.types[r].name,flex:1,renderer:function(e){return e.toFixed(1)}});t.push({text:"Total",dataIndex:"total"}),this.add({xtype:"grid",model:"Niks.Tree.Record",store:e,columns:t,height:120,width:800}),this.add({xtype:"component",width:800,align:"center",html:"<p>Sample Date:   "+Ext.Date.format(this.date,"j M Y")+"</p>"})},types:[],categories:[],series:[],_loadRecordTypeSnapshots:function(e,t,r){var o=[],n="PortfolioItem";return"HierarchicalRequirement"===e.typePath?n=e.typePath:o.push({property:"PortfolioItemType",operator:"=",value:Number(e.type)}),o.push({property:"_TypeHierarchy",value:n}),t&&t.length>0&&(o=o.concat(t)),this._loadRecordSnapshots(o,r)},_loadRecordSnapshots:function(e,t){var r=Ext.create("Deft.Deferred"),o=[{property:"__At",value:Ext.Date.format(t,"Y-m-d\\TH:i:s")},{property:"_ProjectHierarchy",value:this.getContext().getProject().ObjectID}].concat(e);return Ext.create("Rally.data.lookback.SnapshotStore",{filters:o,limit:1/0,pageSize:2e3,useHttpPost:!0,fetch:["_ValidFrom","_ValidTo","ObjectID","Children","Parent","UserStories",this.types[1].name]}).load({callback:function(e,t,o){console.log("callback: ",e,t,o),o?(console.log("Store fetched returned :",e.length),r.resolve(e)):(console.log("Failed to fetch Snapshots: ",t),r.resolve([]))}}),r.promise},_getLowestLevelItems:function(){var e=this.types[0];return this._getOneLevelItems(e,[])},_getTopLevelItems:function(){var e=this.types[this.types.length-1];return this._getOneLevelItems(e,[])},_getOneLevelItems:function(e,t){var r=Ext.create("Deft.Deferred");return this._loadRecordTypeSnapshots(e,t,this.date).then({success:function(e){r.resolve(e)}}),r.promise},_getCollection:function(e,t){var r=[{property:"_ItemHierarchy",operator:"in",value:e.get(t)}],o="UserStories"===t?this.types[1].name:"Parent";return r.push({property:o,value:e.get("ObjectID")}),this._loadRecordSnapshots(r,this.date)},_getChildren:function(e){var t=Ext.create("Deft.Deferred"),r=e.get("PortfolioItemType")===Number(this.types[1].type)?"UserStories":"Children";return e.get(r).length>0?this._getCollection(e,r).then({success:function(r){console.log("Found :"+r.length+" for: ",e),t.resolve(r)},failure:function(e){console.log("Failed to fetch Collection: ",e),t.reject(e)},scope:this}):(console.log("No Children for: ",e),t.resolve([])),t.promise},_Items:[],_getNumbersForType:function(e){var t=Ext.create("Deft.Deferred");return this._getOneLevelItems(e,[],this.date).then({success:function(r){t.resolve({type:e,results:r})},failure:function(r){console.log("Failed to getOneLevelItems for: ",e),t.reject(r)}}),t.promise},launch:function(){var e=this;e.date=new Date(e.getSetting("atDate")),e.setLoading("Fetching portfolio item types"),this._fetchPortfolioItemTypes().then({success:function(t){e.setLoading("Fetching data for: "+Ext.Date.format(e.date,"Y/m/d")),t.splice(0,0,{typePath:"HierarchicalRequirement",name:"User Story",parentType:t[0]}),e.types=t;var r=[];_.each(t,function(t){r.push(function(){return e.setLoading("Fetching all of type: "+t.name),e._getNumbersForType(t)})}),Deft.Chain.sequence(r).then({success:function(t){var r=e._processResults(t);e._drawGrid(r)},failure:function(e){console.log("Failed to fetch sequence: ",e)},scope:e}).always(function(){e.setLoading(!1)})},failure:function(){console.log("Failed to fetch portfolioitem types")},scope:e}).always(function(){e.setLoading(!1)})},_getParentId:function(e){return"HierarchicalRequirement"===e.type.typePath?e.record.get(this.types[1].name):e.record.get("Parent")},getSettingsFields:function(){return[{name:"atDate",fieldLabel:"Use data as of:",xtype:"rallydatefield",allowBlank:!0,blankText:"Use todays date",margin:"0 0 150 0"}]},_fetchPortfolioItemTypes:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]}).load({callback:function(t,r,o){if(o){var n=new Array(t.length);_.each(t,function(e){var t=Number(e.get("Ordinal"));n[t]={typePath:e.get("TypePath"),name:e.get("Name"),type:e.get("_ref").split("/").pop()}});for(var a=0;a<n.length-1;a++)n[a].parentType=n[a+1];e.resolve(n)}else{var s="";r&&r.error&&r.error.errors&&(s=r.error.errors.join(",")),e.reject("Error loading Portfolio Item Types:  "+s)}}}),e.promise}});

            Rally.launchApp('CustomApp', {
                name:"Parentage-Trend",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        p{display:block;margin-top:1em;margin-bottom:1em;margin-left:0;margin-right:0;font-size:16px;width:750;text-align:center}
    </style>
</head>
<body>
</body>
</html>
